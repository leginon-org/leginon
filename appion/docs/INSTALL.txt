Appion-CentOS Install Manual: 

Compiled on %%date(%B %d, %Y)

--------------------------------
= Authors =

Jonathan Brownell, Bridget Carragher, Anchi Cheng, Denis Fellmann, Christopher Irving, Gabe Lander, Pick-wei Lau, Dmitry Lyumkis, Anke Mulder, Sunita Nayak, Clint S. Potter, Jim Pulokas, Joel Quispe, Scott Stagg, Neil R. Voss, and Craig Yoshioka

--------------------------------
= Introduction =

These are the Steps to install Appion on a CentOS machine


== THIS IS INCOMPLETE ==

As of %%date(%B %Y), this document is still incomplete.


== Architecture ==

Appion is built upon Leginon architecture. If you have installed Leginon before, you will find the same three parts of Leginon system installation also applies to Appion systerm.

The three parts are:

- **Python-side** (//pyappion//) that are are either processing programs themselves or wrappers to processing packages used by 3DEM community.
- **MySQL-side** (//appiondata//) that is the set up of database server.
- **PHP-side** (//appionweb//) that includes php and java scripts at the Web server you need to set up to serve as the graphical user interface to the command scripts. 

In addition, Appion also need:

- processing packages not distributed by us, obviously. 

Fortunately, all 3 servers can run on the same machine. If you have many users, it is recommended that you separate the system into 3 computers with one serves the python-side and processing packages and the one for the database, and one for the web. In such a case, you can divide the package requirement by the three server sides as well. 



== What you need ==

You will need 3 servers:

- MySQL database
- Web server
- processing machines (preferrably a PBS system)

Fortunately, all 3 servers can run on the same machine


--------------------------------
= Install CentOS operating system =

[NOTE]
CentOS vs. RHEL
	//CentOS is the exact same as Red Hat Enterprise Linux (RHEL), except that it is free and supported by the community//

The reason I mention CentOS is because I wanted to keep the guide really simple. Another student and I run appion on Fedora 10 and we've run appion on SuSe in the past. I know we gotten most bits working on MacOSX, but some of the python libraries contain ancient Fortran code that does not compile easily on a Mac. But CentOS is certainly not a requirement in general, it is just that the first iteration of the guide is written for CentOS.


== Download the latest ISO disk of CentOS ==

+ ISO files are available at
 - http://wiki.centos.org/Download
+ Click on i386 for 32bit machines or x86_64 for 64bit machines
+ Pick a mirror and download 'CentOS-5.3-x86_64-bin-DVD.iso' file
+


== Burn ISO file to DVD disk ==

Use dvdrecord in Linux to burn disk

``` $ dvdrecord -v -dao gracetime=10 dev=/dev/dvd speed=16 CentOS-5.3-i386-bin-DVD.iso


== Install CentOS 5 with default packages ==

- Only "Desktop - GNOME" is assumed to be installed
- More information available at [CentOS Documentation http://wiki.centos.org/Documentation]



== Add yourself to the sudoers file ==

Add this line below the root version:

``` $ username ALL=(ALL)       ALL

--------------------------------
= Download additional software =


== Install the additional package repositories ==

[NOTE]
There are several additional CentOS repositories that you can install.
These repositories provide additional packages, such as patented software (MP3 players),
closed source applications (Flash plugin, Adobe Acrobat Reader)
and lesser used packages (python numpy, Gnu Scientific Library).
But some repositories install packages over other packages,
which can cause problems and conflicts (ATrpms is bad at this). So I recommend only installing
EPEL and RPM Fusion. Read more here:
[CentOS Additional Repositories http://wiki.centos.org/AdditionalResources/Repositories]


=== Extra Packages for Enterprise Linux (EPEL) ===
- http://fedoraproject.org/wiki/EPEL
- contains a wealth of packages required for appion

.Download repository rpm and install

``` $ sudo rpm -Uvh http://download.fedora.redhat.com/pub/epel/5/`uname -i`/epel-release-5-3.noarch.rpm



=== RPM Fusion ===
- http://rpmfusion.org/
- good for mp3 and other patent limited software

.Download repository rpms and install

```
$ sudo rpm -Uhv http://download1.rpmfusion.org/free/el/updates/testing/5/`uname -i`/rpmfusion-free-release-5-0.1.noarch.rpm
$ sudo rpm -Uvh http://download1.rpmfusion.org/nonfree/el/updates/testing/5/`uname -i`/rpmfusion-nonfree-release-5-0.1.noarch.rpm

```



== Update current packages ==

.Update the updater to make life easier

``` $ sudo yum -y update yum
.Update all packages

``` $ sudo yum -y update

[NOTE]
Download was over 129 MB (in July 2009). If you have a slow internet connection you can setup presto/deltarpms, [see this email http://www.linux-archive.org/centos-development/222706-presto-deltarpm.html]

.Install Complete list of additional packages:

```
$ sudo yum -y install \
python-tools python-devel \ # general applications
subversion ImageMagick grace gnuplot \ # general applications
wxPython numpy scipy python-imaging \ #TILT PICKER
gcc-gfortran compat-gcc-34-g77 \ #FINDEM
gcc-objc fftw3-devel gsl-devel \ #ACE2
mysql mysql-server MySQL-python \ #Sinedon
httpd php php-mysql phpMyAdmin  \ #DBEM
gcc-c++ openmpi-devel libtiff-devel \#Xmipp MPI
php-devel gd-devel re2c fftw2-devel php-gd \#MRC tools
```

If you have an nVidia video card and setup RPM fusion, install the nVidia binary, will speed things up especially for chimera

``` $ sudo yum -y install nvidia-x11-drv

.Clean up packages to save drive space

``` $ sudo yum clean all

.Re-index the hard drive, this will come in handy later

``` $ sudo updatedb

.Enable servers on reboot

``` $ sudo /sbin/chkconfig httpd on
``` $ sudo /sbin/chkconfig mysqld on

You can further configure this with the GUI and turn off unnecessary items

``` $ system-config-services

.Reboot the computer

``` $ sudo reboot


== Download AMI software ==

[NOTE]
AMI software is available from two separate sites [our local servers http://ami.scripps.edu/software/]
and [Google Code http://code.google.com/p/appion/]

- **dbemtools**: web page interface to leginon and appion
 - **dbem**: web interface to pyAppion
 - **project**: for keeping separate projects and web logins
- **leginon**: only for image viewer and polygon tool
 - **pyami** r107, generic image processing
 - **numextension** r52: numpy extension library
 - **sinedon** r50: for MySQL interaction
 - **leginon** r5463: core gui libraries for manual pickers
- **pyappion** r3072: python processing pipeline
 - includes ACE1, ACE2, radermacher module, DoG Picker, TiltPicker, and FindEM


=== from subversion ===
Three packages need to be downloaded from Subversion:

- Leginon, automated EM software

``` $ svn co http://ami.scripps.edu/svn/leginon/branches/1.6/ leginon/

- Pyami, common ami function

``` $ svn co http://ami.scripps.edu/svn/pyami/trunk/ pyami/

- Sinedon, mysql-python object-relational mapping

``` $ svn co http://ami.scripps.edu/svn/sinedon/trunk/ sinedon/

- Numextension python module

``` $ svn co http://ami.scripps.edu/svn/numextension/trunk/ numextension/

- DBEM webpages

``` $ svn co http://ami.scripps.edu/svn/dbem/trunk/ dbem/

- pyAppion python scripts

``` $ svn co http://ami.scripps.edu/svn/pyappion/trunk/ pyappion/

=== online packages ===
Other packages are located online at either http://ami.scripps.edu/software/ or http://appion.org/

From AMI software, http://ami.scripps.edu/software/
- dbemtools, http://ami.scripps.edu/software/dbemtools/
- mrctools, http://ami.scripps.edu/software/mrctools/

From Google Code, http://appion.org/
- pyappion, http://code.google.com/p/appion/downloads/list

== Additional external software needed ==


=== Required ===

 - **EMAN** v1.9 cluster,
  - [download binary http://ncmi.bcm.tmc.edu/ncmi/software/software_details?selected_software=eman]
 - **UCSF Chimera** v1.2509, newer versions have problems,
  - [download binary http://www.cgl.ucsf.edu/chimera/download.html]



=== Recommended ===

- **SPIDER** v15 or older, newest version not supported,
  - [download binary http://www.wadsworth.org/spider_doc/spider/docs/spi-register.html]
- **Xmipp** v2.2 or newer, for alignment, compile your own for openmpi support,
  - [download source http://xmipp.cnb.csic.es/twiki/bin/view/Xmipp/InstallingTheSoftware]
- **IMOD**, for tomography



=== Recommended, but costs money ===

- **MATLAB**, for ACE1
- **IMAGIC** v5, for alignment


--------------------------------
= Compile and setup python (pyappion) programs =


== Compile FindEM ==

- Goto pyappion/findem folder to make findem.exe

- Compile the libraries and binary

``` $ make

- Test findem.exe to see if it runs

``` $ make test

[WARNING]
Only if the first part fails, you must add the path to libg2c.so library file.
Otherwise skip to next section.

- locate libg2c.so library file

``` $ ls /usr/lib/gcc/`uname -i`-redhat-linux/3.4.6/libg2c.so
``` $ locate libg2c.so

- Edit Makefile with location of libg2c.so

``` $ nano Makefile

- Example: EXLIBS=-L/usr/lib/gcc/i386-redhat-linux/3.4.6/ -lg2c
- Re-compile

== Compile Ace2 ==
[WARNING]
ace2 typically requires fftw 3.2 or greater, but you can remove the FFTW_WISDOM_ONLY flag in Image.m

[NOTE]
64 bit binaries are included with pyappion

- Goto pyappion/ace2
- compile the libraries and binary
- test to see if program runs

```
$ make
$ ./ace2.exe -h
$ ./ace2correct.exe -h
$ mv -v ./ace2*.exe ../bin
```



== Compile Radermacher module ==

- Goto pyappion/radermacher

- compile the libraries and binary

``` $ python ./setup.py build

- install module globally

``` $ sudo python ./setup.py install

- test installed module

``` $ python


```
>>> import radermacher
>>> <Ctrl-D>

```



== Compile Numextension module ==

- Goto Leginon/numextension
- compile the libraries and binary

``` $ python ./setup.py build

- install module globally

``` $ sudo python ./setup.py install

- test installed module

``` $ python


```
>>> import numextension
>>> <Ctrl-D>

```



== Globally install python programs ==

- Go into directory with pyami, leginon and sinedon (from Leginon.tgz)
- Setup main python site-packages, depends on ARCH and VERSION

.select the appropriate site-packages folder

```
$ export SITEPKG=/usr/lib/python2.4/site-packages
$ export SITEPKG=/usr/lib64/python2.4/site-packages
$ export SITEPKG=/usr/lib64/python2.5/site-packages

```

- Install Leginon software to main site-packages

``` $ sudo svn co http://ami.scripps.edu/svn/pyami/trunk/ $SITEPKG/pyami/

``` $ sudo svn co http://ami.scripps.edu/svn/leginon/branches/1.6/ $SITEPKG/leginon/

``` $ sudo svn co http://ami.scripps.edu/svn/sinedon/trunk/ $SITEPKG/sinedon/


== Setup leginon.cfg file in your home directory ==

- Copy leginon //default.cfg// to your home directory

``` $ cp $SITEPKG/leginon/config/default.cfg ~/leginon.cfg

- Create a directory for images

``` $ mkdir -p ~/leginon/images/

- Edit ~/leginon.cfg and add image path

``` $ nano ~/leginon.cfg

``` path: ~/leginon/images/

== Test PyAppion ==

- Go into pyappion directory
- Add leginon to PYTHONPATH

``` $ export PYTHONPATH="$SITEPKG/leginon:$PYTHONPATH"

- Add pyappion lib to PYTHONPATH

``` $ export PYTHONPATH="~/pyappion/lib:$PYTHONPATH"

- Run the test script

``` $ ./check.sh

[NOTE]
You can ignore EMAN, MATLAB, and chimera errors at this point

--------------------------------
= Setup MySQL (appiondata) databases =


== Setup MySQL users and databases ==

- Set a MySQL root password, by default it is blank

``` $ mysqladmin -u root password NEWPASSWORD

- Create a new user, database, and give user access to databases

``` $ mysql -u root -p

```
mysql> CREATE USER 'appionuser';
mysql> CREATE DATABASE leginondata;
mysql> CREATE DATABASE projectdata;
mysql> CREATE DATABASE appiondata;
mysql> GRANT ALL PRIVILEGES ON leginondata.* TO appionuser@"%";
mysql> GRANT ALL PRIVILEGES ON projectdata.* TO appionuser@"%";
mysql> GRANT ALL PRIVILEGES ON appiondata.* TO appionuser@"%";
mysql> <Ctrl-D>
```


== Setup Sinedon ==

- Setup a sinedon.cfg in the home directory for all users

``` $ nano ~/sinedon.cfg

- add the following lines to //sinedon.cfg//

```
[global]
host:	'server ip address'

[leginondata]
db:	leginondata
user:	appionuser

[appionData]
db:	appiondata
user:	appionuser

[projectdata]
db:	projectdata
user:	appionuser
```


== Setup Database Tables using Sinedon ==

- Fill databases with tables using maketables.py

``` $ $SITEPKG/sinedon/maketables.py leginondata
``` $ $SITEPKG/sinedon/maketables.py appionData

- Check to make sure it worked:

``` $ echo 'SHOW TABLES;' | mysql -u appionuser appiondata
``` $ echo 'SHOW TABLES;' | mysql -u appionuser leginondata

[NOTE]
the leginon and appion folders need to be in your PYTHONPATH for this to work

--------------------------------
= Install webpages (appionweb) =


== Install MRC Tools ==

- Go to your php devel directory and untar the archive

```
$ cd /usr/include/php/ext/
$ sudo mkdir mrc
$ sudo chmod 777 mrc
$ sudo chown $USER mrc
```

- Unpackage MRC Tools from http://ami.scripps.edu/software/mrctools/

```
$ tar zxvf ~/php_mrc.tgz
$ cd mrc/
```

- Compile and install the MRC module

``` 
$ phpize
$ ./configure 
$ make
$ sudo make install
``` 

- Edit your php configuration file php.ini to add "mrc.so" extension.
- You might also increase the memory_limit field. It is set to 8M by default. The more the merrier!
- 4kx4k float MRC image is about 64MB

``` $ sudo nano /etc/php.d/mrc.ini

- add mrc.so to extensions

```
; Enable mrc extension module
extension=mrc.so
```

- increase the memory limit, EM images are big 64MB

``` memory_limit = 256M; Maximum amount of memory

- Paths and Directories -- include_path should at least have "."

``` include_path = ".:/php/includes"

- restart the webserver

``` $ sudo /sbin/service httpd restart


== Install DBEM source ==

install appionweb

``` 
$ cd /var/www/html/
$ sudo mkdir appionweb
$ sudo chmod 777 appionweb
$ sudo chown $USER appionweb
$ svn co http://ami.scripps.edu/svn/dbem/trunk/ appionweb/
$ cd appionweb
``` 

install php include modules

```
$ sudo mkdir -p /php/includes
$ sudo chmod 777 /php/includes
$ sudo chown $USER /php/includes
$ cd
$ svn co http://ami.scripps.edu/svn/phpami/trunk/ phpami/
$ cp -v phpami/inc/mysql.inc.php /php/includes/mysql.inc
$ cp -v phpami/inc/session.inc.php /php/includes/session.inc
$ cp -v phpami/inc/ssh.inc.php /php/includes/ssh.inc
```


== Configuration ==
- edit the file **config.php**

``` $ cp config.php.template config.php
``` $ nano config.php

- set your MySQL parameters:

```
$DB_HOST	= "localhost";
$DB_USER	= "appionuser";
$DB_PASS	= "";
$DB		= "leginondata";

define(BASE_URL, "/appionweb/");
```

- if you use a project database, set the following

```
$PROJECT_URL = "localhost";
$PROJECT_DB_HOST = "[server ip address]";
$PROJECT_DB_USER = "appionuser";
$PROJECT_DB_PASS = "";
$PROJECT_DB = "projectdata";
```


== Test ==
Go to http://localhost/appionweb/

[NOTE]
You may need to configure your firewall to allow incoming HTTP (port 80) and MySQL (port 3306) traffic:
``` $ system-config-securitylevel

--------------------------------
= Install external packages =

== Install Xmipp ==

- For more info, see http://xmipp.cnb.csic.es/twiki/bin/view/Xmipp/InstallingTheSoftware
- Go into Xmipp source directory
- Find openmpi directory

``` $ locate libmpi.so
``` /usr/lib/openmpi/1.2.7-gcc/lib/libmpi.so

- Setup Xmipp to use openmpi by changing three lines in SConstruct

``` $ cp SConstruct SConstruct.orig
``` $ nano SConstruct
```
opts.Add('MPI_INCLUDE', 'MPI headers dir ', '/usr/lib/openmpi/1.2.7-gcc/include/')
opts.Add('MPI_LIBDIR', 'MPI libraries dir ', '/usr/lib/openmpi/1.2.7-gcc/lib/')
opts.Add('MPI_LIB', 'MPI library', 'mpi')

```

- Compile

``` $ sudo mpi-selector --yes --system --set `rpm --qf '%{NAME}-%{VERSION}-gcc-%{ARCH}\n' -q openmpi`
``` $ export PATH=$PATH:/usr/lib/openmpi/1.2.7-gcc/bin
``` $ ./scons.configure

you should see the line:
``` * Checking for MPI ... yes

``` $ ./scons.compile

--------------------------------
= Install a PBS job submission system =

You'll need to install a [Portable Batch System http://en.wikipedia.org/wiki/Portable_Batch_System] for job submission, such as [TORQUE http://en.wikipedia.org/wiki/TORQUE_Resource_Manager] or
openPBS. I know Torque comes with Fedora 10, but not CentOS.

- An RPM is available in the EPEL testing section

``` $ sudo yum -y --enablerepo=epel-testing install torque

or another way to get packages


```
$ wget http://centos.karan.org/el5/extras/testing/`uname -i`/RPMS/torque-2.1.9-1.el5.kb.`uname -i`.rpm
$ sudo yum -y localinstall --nogpgcheck torque-2.1.9-1.el5.kb.`uname -i`.rpm
$ #sudo rpm -Uhv torque-2.1.9-1.el5.kb.`uname -i`.rpm

```

--------------------------------
= Setting environmental variables =

== System variables ==
- PYTHONPATH
- PATH
- LD_LIBRARY_PATH

== External package variables ==
- EMAN
- XMIPP
- SPIDER

--------------------------------
= THIS IS INCOMPLETE =

Sorry this document is NOT complete

Compiled on %%date(%B %d, %Y)


